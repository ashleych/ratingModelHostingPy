{% extends "_layout.html" %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Financial Statement for {{ statement.customer.customer_name }}</h1>
<div id="hot-app"></div>

<script>
  const data = {{ data | tojson | safe }};
  const container = document.getElementById('hot-app');
  const hot = new Handsontable(container, {
    data: data,
    colHeaders: ['Field', 'Value'],
    columns: [
      { data: 0, readOnly: true },
      { data: 1, type: 'numeric', numericFormat: { pattern: '0,0.00' } }
    ],
    width: '100%',
    height: 'auto',
    licenseKey: 'non-commercial-and-evaluation'
  });

  hot.addHook('afterChange', function(changes, source) {
    if (source === 'edit') {
      changes.forEach(([row, prop, oldValue, newValue]) => {
        if (prop === 1) {  // Only for the 'Value' column
          const fieldName = hot.getDataAtCell(row, 0);
          htmx.ajax('POST', '/statements/{{ statement.id }}/update', {
            target: '#hot-app',
            swap: 'none',
            values: {
              field_name: fieldName,
              new_value: newValue
            }
          }).then(() => {
            hot.render();
          });
        }
      });
    }
  });
</script>
{% endblock %}