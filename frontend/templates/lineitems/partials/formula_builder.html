<!-- Add this to your edit.html, just before the closing body tag -->
<div id="formulaBuilderModal" class="relative z-10 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl sm:p-6">
                <!-- Modal Header -->
                <div class="mb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100">
                        Formula Builder
                    </h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Build your formula by selecting line items and operators
                    </p>
                </div>

                <!-- Formula Display -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Current Formula
                    </label>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-3 font-mono text-sm break-all min-h-[3rem]" id="formulaDisplay">
                    </div>
                </div>

                <!-- Builder Controls -->
                <div class="space-y-4">
                    <!-- Line Items Dropdown -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Select Line Item
                        </label>
                        <select id="lineItemSelect" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
                            <option value="">Choose a line item...</option>
                            {% for item in available_items %}
                            <option value="{{ item.name }}">{{ item.label }}</option>
                            {% endfor %}
                        </select>
                        <button onclick="addToFormula('lineItemSelect')"
                                class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Add Item
                        </button>
                    </div>

                    <!-- Operators -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Operators
                        </label>
                        <div class="flex space-x-2">
                            <button onclick="addOperator('+')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                +
                            </button>
                            <button onclick="addOperator('-')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                -
                            </button>
                            <button onclick="addOperator('*')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                ร
                            </button>
                            <button onclick="addOperator('/')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                รท
                            </button>
                            <button onclick="addOperator('(')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                (
                            </button>
                            <button onclick="addOperator(')')"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                )
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-6 flex justify-between">
                    <button onclick="clearFormula()"
                            type="button"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Clear Formula
                    </button>
                    <div class="space-x-3">
                        <button onclick="closeFormulaBuilder()"
                                type="button"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            Cancel
                        </button>
                        <button onclick="applyFormula()"
                                type="button"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Apply Formula
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add a button next to the formula input -->
<!-- Update your formula input field to include the builder button -->
<div class="space-y-1">
    <label for="formula" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Formula
    </label>
    <div class="mt-1 relative flex space-x-2">
        <input type="text"
               name="formula"
               id="formula"
               value="{{ line_item.formula.strip() if line_item.formula else '' }}"
               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm font-mono">
        <button type="button"
                onclick="openFormulaBuilder()"
                class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Build Formula
        </button>
    </div>
</div>

<script>
let currentFormula = '';

function openFormulaBuilder() {
    // Initialize the formula builder with existing formula
    currentFormula = document.getElementById('formula').value;
    document.getElementById('formulaDisplay').textContent = currentFormula;
    document.getElementById('formulaBuilderModal').classList.remove('hidden');
}

function closeFormulaBuilder() {
    document.getElementById('formulaBuilderModal').classList.add('hidden');
}

function addToFormula(selectId) {
    const select = document.getElementById(selectId);
    if (select.value) {
        if (currentFormula && !currentFormula.endsWith(' ')) {
            currentFormula += ' ';
        }
        currentFormula += select.value;
        updateFormulaDisplay();
        select.selectedIndex = 0;
    }
}

function addOperator(operator) {
    if (currentFormula && !currentFormula.endsWith(' ')) {
        currentFormula += ' ';
    }
    currentFormula += operator;
    if (operator !== '(' && operator !== ')') {
        currentFormula += ' ';
    }
    updateFormulaDisplay();
}

function updateFormulaDisplay() {
    const display = document.getElementById('formulaDisplay');
    display.textContent = currentFormula;
}

function clearFormula() {
    currentFormula = '';
    updateFormulaDisplay();
}

function applyFormula() {
    document.getElementById('formula').value = currentFormula.trim();
    closeFormulaBuilder();
}

// Add keyboard shortcut (Escape to close)
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeFormulaBuilder();
    }
});
</script>
