{% extends "_layout.html" %}


{% macro render_factor(factor) %}
<div class="grid grid-cols-3 gap-4 mt-2">
    <div class="text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center">
        {{ factor.label }}
        {% if factor.weightage %}
            ({{ factor.weightage * 100 }}%)
        {% endif %}
        {% if factor.input_source == 'user_input' and factor.factor_attributes %}
            <button class="edit-btn ml-2 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300"
                    data-factor-id="{{ factor.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        <span class="factor-value" data-factor-id="{{ factor.id }}">
            {% if factor.raw_value_text %}
                {{ factor.raw_value_text }}
            {% elif factor.raw_value_float is not none %}
                {{ factor.raw_value_float }}
            {% else %}
                N/A
            {% endif %}
        </span>
        {% if factor.input_source == 'user_input' and factor.factor_attributes %}
            <select class="factor-input hidden w-full text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                    data-factor-id="{{ factor.id }}">
                {% for attribute in factor.factor_attributes %}
                    <option value="{{ attribute.label }}" {% if attribute.label == factor.raw_value_text %}selected{% endif %}>
                        {{ attribute.label }}
                    </option>
                {% endfor %}
            </select>
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        <span class="factor-score" data-factor-id="{{ factor.id }}">{{ factor.score }}</span>
    </div>
</div>
{% endmacro %}
{% block content %}


<p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
    Rating date: {{ rating_instance.created_at.strftime('%Y-%m-%d') }}
</p>



<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8" id="ratingView">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-gray-100 sm:text-3xl sm:truncate">
            Rating for {{ customer.customer_name }}
        </h2>
        <div class="relative">
            <button id="settingsButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="settingsMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5">
                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 font-medium">Settings</div>
                    
                    <!-- View Options -->
                    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 font-medium">View Options</div>
                    <a href="?view_type=tabbed" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Tabbed View</a>
                    <a href="?view_type=single" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Single Page View</a>
                    
                    <!-- Download Options -->
                    <div class="mt-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Download Options</div>
                    <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='docx') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Download DOCX</a>
                    <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='pdf') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Download PDF</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rest of the content remains the same -->
        {% if view_type == 'tabbed' %}
    <div class="mt-6">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% for module, factors in structured_data.items() %}
                <a href="#{{ module | replace(' ', '_') }}" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm
                          text-gray-500 hover:text-gray-700 hover:border-gray-300
                          dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-300
                          focus:outline-none transition duration-150 ease-in-out"
                    data-tab="{{ module | replace(' ', '_') }}">
                    {{ module }}
                </a>
                {% endfor %}
            </nav>
        </div>

        {% for module, factors in structured_data.items() %}
        <div id="{{ module | replace(' ', '_') }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mt-4 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
            {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mt-6">
        {% for module, factors in structured_data.items() %}
        <div class="mb-8">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
            {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
    /* Previous styles remain the same */
    .tab-link.active {
        color: #4f46e5;
        /* Indigo-600 */
        border-color: #4f46e5;
        /* Indigo-600 */
    }

    .dark .tab-link.active {
        color: #6366f1;
        /* Indigo-500 for dark mode */
        border-color: #6366f1;
        /* Indigo-500 for dark mode */
    }

    .tab-link:not(.active) {
        border-color: transparent;
    }

    .dark .tab-link:not(:hover):not(.active) {
        border-color: transparent;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    const settingsButton = document.getElementById('settingsButton');
    const settingsMenu = document.getElementById('settingsMenu');

    const editButtons = document.querySelectorAll('.edit-btn');
        function activateTab(tabName) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabs.forEach(tab => tab.classList.remove('active'));

            const activeContent = document.getElementById(tabName);
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);

            if (activeContent) activeContent.classList.remove('hidden');
            if (activeTab) activeTab.classList.add('active');
        }
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            activateTab(tab.getAttribute('data-tab'));
        });
    });

    // Activate the first tab by default in tabbed view
    if (tabs.length > 0 && '{{ view_type }}' === 'tabbed') {
        activateTab(tabs[0].getAttribute('data-tab'));
    }

    // Toggle settings menu
    settingsButton.addEventListener('click', () => {
        settingsMenu.classList.toggle('hidden');
    });

    // Close settings menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
            settingsMenu.classList.add('hidden');
        }
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    console.log('Rating script loaded');

    const contentContainer = document.querySelector('#ratingView');  // Adjust this selector to match your content container
    
    if (!contentContainer) {
        console.error('Content container not found');
        return;
    }

    console.log('Content container found:', contentContainer);

    document.addEventListener('click', function(e) {
        console.log('Click event triggered on content container');
        console.log('Clicked element:', e.target);

        let targetButton = e.target.closest('button');
        if (!targetButton) {
            console.log('No button found in the click path');
            return;
        }

        console.log('Target button:', targetButton);
        console.log('Target button classes:', targetButton.classList);

        if (targetButton.classList.contains('edit-btn')) {
            console.log('Edit button clicked');
            handleEditClick(targetButton);
        } else if (targetButton.classList.contains('save-btn')) {
            console.log('Save button clicked');
            handleSaveClick(targetButton);
        }
    });

    function handleEditClick(editButton) {
        const factorId = editButton.getAttribute('data-factor-id');
        console.log('Editing factor:', factorId);

        const valueSpan = document.querySelector(`.factor-value[data-factor-id="${factorId}"]`);
        const selectField = document.querySelector(`.factor-input[data-factor-id="${factorId}"]`);
        
        if (!valueSpan || !selectField) {
            console.error('Value span or select field not found for factor:', factorId);
            return;
        }

        valueSpan.classList.add('hidden');
        selectField.classList.remove('hidden');
        selectField.focus();

        // Change edit button to save button
        editButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        `;
        editButton.classList.add('save-btn');
        editButton.classList.remove('edit-btn');
    }

    function handleSaveClick(saveButton) {
        const factorId = saveButton.getAttribute('data-factor-id');
        console.log('Saving factor:', factorId);

        const selectField = document.querySelector(`.factor-input[data-factor-id="${factorId}"]`);
        const valueSpan = document.querySelector(`.factor-value[data-factor-id="${factorId}"]`);
        
        if (!selectField || !valueSpan) {
            console.error('Select field or value span not found for factor:', factorId);
            return;
        }

        console.log('New value:', selectField.value);

        // Send AJAX request to update the value
        fetch('/api/update_factor_value', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                factor_id: factorId,
                new_value: selectField.value
            }),
        })
        .then(response => {
            console.log('Received response:', response);
            return response.json();
        })
        .then(data => {
            console.log('Parsed response data:', data);
            if (data.success) {
                console.log('Update successful');
                valueSpan.textContent = selectField.value;
                const scoreSpan = document.querySelector(`.factor-score[data-factor-id="${factorId}"]`);
                if (scoreSpan) {
                    scoreSpan.textContent = data.new_score;
                }
                
                // Update derived values
                for (let derivedFactor of data.updated_derived_factors) {
                    const derivedValueSpan = document.querySelector(`.factor-value[data-factor-id="${derivedFactor.id}"]`);
                    const derivedScoreSpan = document.querySelector(`.factor-score[data-factor-id="${derivedFactor.id}"]`);
//                    if (derivedValueSpan) derivedValueSpan.textContent = derivedFactor.raw_value;
                    if (derivedScoreSpan) derivedScoreSpan.textContent = derivedFactor.new_score;
                }
            } else {
                console.error('Update failed:', data.error);
                alert('Failed to update value. Please try again.');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
        
        valueSpan.classList.remove('hidden');
        selectField.classList.add('hidden');

        // Change save button back to edit button
        saveButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
        `;
        saveButton.classList.add('edit-btn');
        saveButton.classList.remove('save-btn');
    }
});
</script>
{% endblock %}