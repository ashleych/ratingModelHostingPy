{% extends "_layout.html" %}

{% macro render_factor(factor) %}
<div class="grid grid-cols-3 gap-4 mt-2">
    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
        {{ factor.label }}
        {% if factor.weightage %}
        ({{ factor.weightage * 100 }}%)
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        {% if factor.raw_value_text %}
        {{ factor.raw_value_text }}
        {% elif factor.raw_value_float is not none %}
        {{ factor.raw_value_float }}
        {% else %}
        N/A
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        {{ factor.score }}
    </div>
</div>
{% endmacro %}

{% block content %}


<p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
    Rating date: {{ rating_instance.created_at.strftime('%Y-%m-%d') }}
</p>



<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-gray-100 sm:text-3xl sm:truncate">
            Rating for {{ customer.customer_name }}
        </h2>
        <div class="relative">
            <button id="settingsButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="settingsMenu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5">
                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 font-medium">Settings</div>
                    
                    <!-- View Options -->
                    <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 font-medium">View Options</div>
                    <a href="?view_type=tabbed" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Tabbed View</a>
                    <a href="?view_type=single" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Single Page View</a>
                    
                    <!-- Download Options -->
                    <div class="mt-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Download Options</div>
                    <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='docx') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Download DOCX</a>
                    <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='pdf') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 pl-8">Download PDF</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rest of the content remains the same -->
        {% if view_type == 'tabbed' %}
    <div class="mt-6">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% for module, factors in structured_data.items() %}
                <a href="#{{ module | replace(' ', '_') }}" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm
                          text-gray-500 hover:text-gray-700 hover:border-gray-300
                          dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-300
                          focus:outline-none transition duration-150 ease-in-out"
                    data-tab="{{ module | replace(' ', '_') }}">
                    {{ module }}
                </a>
                {% endfor %}
            </nav>
        </div>

        {% for module, factors in structured_data.items() %}
        <div id="{{ module | replace(' ', '_') }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mt-4 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
            {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mt-6">
        {% for module, factors in structured_data.items() %}
        <div class="mb-8">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
            {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
    /* Previous styles remain the same */
    .tab-link.active {
        color: #4f46e5;
        /* Indigo-600 */
        border-color: #4f46e5;
        /* Indigo-600 */
    }

    .dark .tab-link.active {
        color: #6366f1;
        /* Indigo-500 for dark mode */
        border-color: #6366f1;
        /* Indigo-500 for dark mode */
    }

    .tab-link:not(.active) {
        border-color: transparent;
    }

    .dark .tab-link:not(:hover):not(.active) {
        border-color: transparent;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    const settingsButton = document.getElementById('settingsButton');
    const settingsMenu = document.getElementById('settingsMenu');

        function activateTab(tabName) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabs.forEach(tab => tab.classList.remove('active'));

            const activeContent = document.getElementById(tabName);
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);

            if (activeContent) activeContent.classList.remove('hidden');
            if (activeTab) activeTab.classList.add('active');
        }
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            activateTab(tab.getAttribute('data-tab'));
        });
    });

    // Activate the first tab by default in tabbed view
    if (tabs.length > 0 && '{{ view_type }}' === 'tabbed') {
        activateTab(tabs[0].getAttribute('data-tab'));
    }

    // Toggle settings menu
    settingsButton.addEventListener('click', () => {
        settingsMenu.classList.toggle('hidden');
    });

    // Close settings menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
            settingsMenu.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}