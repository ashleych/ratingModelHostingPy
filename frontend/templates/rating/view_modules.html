{% extends "_layout.html" %}

{% macro render_factor(factor) %}
<div class="grid grid-cols-3 gap-4 mt-2">
    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
        {{ factor.label }}
        {% if factor.weightage %}
            ({{ factor.weightage * 100 }}%)
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        {% if factor.raw_value_text %}
            {{ factor.raw_value_text }}
        {% elif factor.raw_value_float is not none %}
            {{ factor.raw_value_float }}
        {% else %}
            N/A
        {% endif %}
    </div>
    <div class="text-sm text-gray-900 dark:text-gray-100">
        {{ factor.score }}
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-gray-100 sm:text-3xl sm:truncate">
        Rating for {{ customer.customer_name }}
    </h2>
    <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
        Rating date: {{ rating_instance.created_at.strftime('%Y-%m-%d') }}
    </p>

    <div class="mt-4 flex justify-between items-center">
        <div>
            <a href="?view_type=tabbed" class="mr-4 {% if view_type == 'tabbed' %}font-bold{% endif %}">Tabbed View</a>
            <a href="?view_type=single" class="{% if view_type == 'single' %}font-bold{% endif %}">Single Page View</a>
        </div>
        <div>
            <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='docx') }}" class="mr-4">Download DOCX</a>
            <a href="{{ url_for('download_rating_report', customer_id=customer.id, format='pdf') }}">Download PDF</a>
        </div>
    </div>

    {% if view_type == 'tabbed' %}
    <div class="mt-6">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                {% for module, factors in structured_data.items() %}
                <a href="#{{ module | replace(' ', '_') }}" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="{{ module | replace(' ', '_') }}">
                    {{ module }}
                </a>
                {% endfor %}
            </nav>
        </div>

        {% for module, factors in structured_data.items() %}
        <div id="{{ module | replace(' ', '_') }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mt-4 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
                {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="mt-6">
        {% for module, factors in structured_data.items() %}
        <div class="mb-8">
            <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mb-2">{{ module }}</h3>
            <div class="grid grid-cols-3 gap-4 font-bold mb-2">
                <div>Factor</div>
                <div>Raw Value</div>
                <div>Score</div>
            </div>
            {% for factor in factors %}
                {{ render_factor(factor) }}
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');

    function activateTab(tabName) {
        tabContents.forEach(content => content.classList.add('hidden'));
        tabs.forEach(tab => tab.classList.remove('text-indigo-600', 'border-indigo-600'));

        const activeContent = document.getElementById(tabName);
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);

        if (activeContent) activeContent.classList.remove('hidden');
        if (activeTab) {
            activeTab.classList.add('text-indigo-600', 'border-indigo-600');
            activeTab.classList.remove('text-gray-500', 'border-transparent');
        }
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            activateTab(tab.getAttribute('data-tab'));
        });
    });
});
</script>
{% endblock %}